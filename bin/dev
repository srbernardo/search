#!/usr/bin/env sh
set -e

if ! gem list foreman -i --silent; then
  echo "Installing foreman..."
  gem install foreman
fi

if [ -z "${LD_PRELOAD+x}" ]; then
  LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
  export LD_PRELOAD
fi

if [ -f tmp/pids/server.pid ]; then
  rm tmp/pids/server.pid
fi

until pg_isready -h db -U postgres; do
  echo "Waiting for PostgreSQL to become available..."
  sleep 2
done

rails db:prepare

exec foreman start -f Procfile.dev "$@"
